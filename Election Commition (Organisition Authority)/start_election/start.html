<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" >
	<head>
		<meta http-equiv="content-type" content="text/html" charset="utf-8" />
		<title>start_election</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="" >
		<link rel="StyleSheet" href="start_election.css" />
		<script src="https://secure.exportkit.com/cdn/js/ek_googlefonts.js"></script>
         <script src="./node_modules/web3/dist/web3.min.js"></script>
        </head>
<body>
		<div id="content-container" >
			<div id="_bg__start_election"  ></div>
			<div id="election_" >
				Election:
			</div>
			
			<div id="select_start_time__" >
			Enter no. of hours:
			</div>
			</div>
			<form>
			<div id="starttim"><input type="text"></div>
			</form>
			<div id="back" ><button class="button button1" onclick="onBack()">Back</button>
				
			</div>

			<div id="group_2"  ><button class="button button2"type="Submit" onclick="onclickConfirm()">Confirm</button>
			</div>

		</div>
		 <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
		<script>
			function hideDetail(){
				var btn = document.getElementById("starttim")
      			btn.style.display = 'none';
      			var abc =  document.getElementById("select_start_time__")
      			abc.innerHTML = "Election has been started for "+hours+"hours"
			} 


       if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            //var Web3 = require('web3');
        var web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
        }
        web3.eth.defaultAccount = web3.eth.accounts[0];

             let abi ='[{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"deployedBallots","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getsDeployedBallots","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string[][]","name":"candidates","type":"string[][]"},{"internalType":"string[][]","name":"party","type":"string[][]"},{"internalType":"string[]","name":"district","type":"string[]"},{"internalType":"uint256","name":"hour","type":"uint256"}],"name":"startelec","outputs":[],"stateMutability":"nonpayable","type":"function"}]';


        let account = '0x651695Fcd84845afe63B8060aB0ea591928CdF12'


        let bytecode = "0x608060405234801561001057600080fd5b50611e7d806100206000396000f3fe60806040523480156200001157600080fd5b5060043610620000465760003560e01c80630e3e4a75146200004b5780638455faf8146200006d578063cdf74c3e146200008d575b600080fd5b62000055620000c3565b60405162000064919062000773565b60405180910390f35b6200008b600480360362000085919081019062000492565b62000153565b005b620000ab6004803603620000a5919081019062000549565b6200025d565b604051620000ba919062000756565b60405180910390f35b606060008054806020026020016040519081016040528092919081815260200182805480156200014957602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311620000fe575b5050505050905090565b60008090505b8251811015620002565760008582815181106200017257fe5b60200260200101518583815181106200018757fe5b60200260200101518584815181106200019c57fe5b60200260200101513386604051620001b4906200029a565b620001c495949392919062000797565b604051809103906000f080158015620001e1573d6000803e3d6000fd5b5090506000819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050808060010191505062000159565b5050505050565b600081815481106200026b57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6113df8062000a6983390190565b600082601f830112620002ba57600080fd5b8135620002d1620002cb8262000837565b62000809565b9150818183526020840193506020810190508360005b838110156200031b578135860162000300888262000325565b845260208401935060208301925050600181019050620002e7565b5050505092915050565b600082601f8301126200033757600080fd5b81356200034e620003488262000860565b62000809565b9150818183526020840193506020810190508360005b838110156200039857813586016200037d88826200041f565b84526020840193506020830192505060018101905062000364565b5050505092915050565b600082601f830112620003b457600080fd5b8135620003cb620003c58262000889565b62000809565b9150818183526020840193506020810190508360005b83811015620004155781358601620003fa88826200041f565b845260208401935060208301925050600181019050620003e1565b5050505092915050565b600082601f8301126200043157600080fd5b8135620004486200044282620008b2565b62000809565b915080825260208301602083018583830111156200046557600080fd5b62000472838284620009f8565b50505092915050565b6000813590506200048c8162000a4e565b92915050565b60008060008060808587031215620004a957600080fd5b600085013567ffffffffffffffff811115620004c457600080fd5b620004d287828801620002a8565b945050602085013567ffffffffffffffff811115620004f057600080fd5b620004fe87828801620002a8565b935050604085013567ffffffffffffffff8111156200051c57600080fd5b6200052a87828801620003a2565b92505060606200053d878288016200047b565b91505092959194509250565b6000602082840312156200055c57600080fd5b60006200056c848285016200047b565b91505092915050565b6000620005838383620005b6565b60208301905092915050565b60006200059d8383620006c3565b905092915050565b620005b081620009bc565b82525050565b620005c1816200097e565b82525050565b620005d2816200097e565b82525050565b6000620005e582620008ff565b620005f181856200093a565b9350620005fe83620008df565b8060005b838110156200063557815162000619888262000575565b9750620006268362000920565b92505060018101905062000602565b5085935050505092915050565b60006200064f826200090a565b6200065b81856200094b565b9350836020820285016200066f85620008ef565b8060005b85811015620006b157848403895281516200068f85826200058f565b94506200069c836200092d565b925060208a0199505060018101905062000673565b50829750879550505050505092915050565b6000620006d08262000915565b620006dc81856200095c565b9350620006ee81856020860162000a07565b620006f98162000a3d565b840191505092915050565b6000620007118262000915565b6200071d81856200096d565b93506200072f81856020860162000a07565b6200073a8162000a3d565b840191505092915050565b6200075081620009b2565b82525050565b60006020820190506200076d6000830184620005c7565b92915050565b600060208201905081810360008301526200078f8184620005d8565b905092915050565b600060a0820190508181036000830152620007b3818862000642565b90508181036020830152620007c9818762000642565b90508181036040830152620007df818662000704565b9050620007f06060830185620005a5565b620007ff608083018462000745565b9695505050505050565b6000604051905081810181811067ffffffffffffffff821117156200082d57600080fd5b8060405250919050565b600067ffffffffffffffff8211156200084f57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156200087857600080fd5b602082029050602081019050919050565b600067ffffffffffffffff821115620008a157600080fd5b602082029050602081019050919050565b600067ffffffffffffffff821115620008ca57600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b60006200098b8262000992565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000620009c982620009d0565b9050919050565b6000620009dd82620009e4565b9050919050565b6000620009f18262000992565b9050919050565b82818337600083830152505050565b60005b8381101562000a2757808201518184015260208101905062000a0a565b8381111562000a37576000848401525b50505050565b6000601f19601f8301169050919050565b62000a5981620009b2565b811462000a6557600080fd5b5056fe60806040523480156200001157600080fd5b50604051620013df380380620013df83398181016040526200003791908101906200042f565b81600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600290805190602001906200009092919062000196565b5060008090505b85518110156200018a5760006040518060a00160405280888481518110620000bb57fe5b60200260200101518152602001878481518110620000d557fe5b6020026020010151815260200160008152602001428152602001844201815250908060018154018082558091505060019003906000526020600020906005020160009091909190915060008201518160000190805190602001906200013c9291906200021d565b5060208201518160010190805190602001906200015b9291906200021d565b506040820151816002015560608201518160030155608082015181600401555050808060010191505062000097565b50505050505062000655565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620001d957805160ff19168380011785556200020a565b828001600101855582156200020a579182015b8281111562000209578251825591602001919060010190620001ec565b5b509050620002199190620002a4565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200026057805160ff191683800117855562000291565b8280016001018555821562000291579182015b828111156200029057825182559160200191906001019062000273565b5b509050620002a09190620002a4565b5090565b620002c991905b80821115620002c5576000816000905550600101620002ab565b5090565b90565b600081519050620002dd8162000621565b92915050565b600082601f830112620002f557600080fd5b81516200030c62000306826200052a565b620004fc565b9150818183526020840193506020810190508360005b838110156200035657815186016200033b888262000360565b84526020840193506020830192505060018101905062000322565b5050505092915050565b600082601f8301126200037257600080fd5b815162000389620003838262000553565b620004fc565b91508082526020830160208301858383011115620003a657600080fd5b620003b3838284620005eb565b50505092915050565b600082601f830112620003ce57600080fd5b8151620003e5620003df8262000580565b620004fc565b915080825260208301602083018583830111156200040257600080fd5b6200040f838284620005eb565b50505092915050565b60008151905062000429816200063b565b92915050565b600080600080600060a086880312156200044857600080fd5b600086015167ffffffffffffffff8111156200046357600080fd5b6200047188828901620002e3565b955050602086015167ffffffffffffffff8111156200048f57600080fd5b6200049d88828901620002e3565b945050604086015167ffffffffffffffff811115620004bb57600080fd5b620004c988828901620003bc565b9350506060620004dc88828901620002cc565b9250506080620004ef8882890162000418565b9150509295509295909350565b6000604051905081810181811067ffffffffffffffff821117156200052057600080fd5b8060405250919050565b600067ffffffffffffffff8211156200054257600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156200056b57600080fd5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff8211156200059857600080fd5b601f19601f8301169050602081019050919050565b6000620005ba82620005c1565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b838110156200060b578082015181840152602081019050620005ee565b838111156200061b576000848401525b50505050565b6200062c81620005ad565b81146200063857600080fd5b50565b6200064681620005e1565b81146200065257600080fd5b50565b610d7a80620006656000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c8063716c424e11610071578063716c424e1461017e57806372b9d6161461019c578063a3ec138d146101ba578063b2c2f2e8146101ea578063be1c766b1461021a578063e13804a714610238576100a9565b80630121b93f146100ae57806330e4f84d146100de5780633477ee2e146100fc578063456645a714610130578063481c6a7514610160575b600080fd5b6100c860048036036100c39190810190610977565b610268565b6040516100d59190610b7b565b60405180910390f35b6100e66102d4565b6040516100f39190610b1c565b60405180910390f35b61011660048036036101119190810190610977565b6103cd565b604051610127959493929190610b9d565b60405180910390f35b61014a60048036036101459190810190610977565b610540565b6040516101579190610b7b565b60405180910390f35b61016861062a565b6040516101759190610b01565b60405180910390f35b610186610650565b6040516101939190610b59565b60405180910390f35b6101a46106ee565b6040516101b19190610b1c565b60405180910390f35b6101d460048036036101cf919081019061094e565b6107e7565b6040516101e19190610b3e565b60405180910390f35b61020460048036036101ff9190810190610977565b610807565b6040516102119190610bfe565b60405180910390f35b61022261082e565b60405161022f9190610bfe565b60405180910390f35b610252600480360361024d9190810190610977565b61083a565b60405161025f9190610b7b565b60405180910390f35b606060016000838154811061027957fe5b9060005260206000209060050201600201600082825401925050819055506040518060400160405280600781526020017f434f554e544544000000000000000000000000000000000000000000000000008152509050919050565b60608060008090505b6000805490508110156103c557600081815481106102f757fe5b90600052602060002090600502016001018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561039c5780601f106103715761010080835404028352916020019161039c565b820191906000526020600020905b81548152906001019060200180831161037f57829003601f168201915b50505050508282815181106103ad57fe5b602002602001018190525080806001019150506102dd565b508091505090565b600081815481106103da57fe5b9060005260206000209060050201600091509050806000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104865780601f1061045b57610100808354040283529160200191610486565b820191906000526020600020905b81548152906001019060200180831161046957829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105245780601f106104f957610100808354040283529160200191610524565b820191906000526020600020905b81548152906001019060200180831161050757829003601f168201915b5050505050908060020154908060030154908060040154905085565b60606000828154811061054f57fe5b906000526020600020906005020160040154421161056c57600080fd5b6000828154811061057957fe5b90600052602060002090600502016001018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561061e5780601f106105f35761010080835404028352916020019161061e565b820191906000526020600020905b81548152906001019060200180831161060157829003601f168201915b50505050509050919050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106e65780601f106106bb576101008083540402835291602001916106e6565b820191906000526020600020905b8154815290600101906020018083116106c957829003601f168201915b505050505081565b60608060008090505b6000805490508110156107df576000818154811061071157fe5b90600052602060002090600502016000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107b65780601f1061078b576101008083540402835291602001916107b6565b820191906000526020600020905b81548152906001019060200180831161079957829003601f168201915b50505050508282815181106107c757fe5b602002602001018190525080806001019150506106f7565b508091505090565b60036020528060005260406000206000915054906101000a900460ff1681565b600080828154811061081557fe5b9060005260206000209060050201600201549050919050565b60008080549050905090565b60606000828154811061084957fe5b906000526020600020906005020160040154421161086657600080fd5b6000828154811061087357fe5b90600052602060002090600502016000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109185780601f106108ed57610100808354040283529160200191610918565b820191906000526020600020905b8154815290600101906020018083116108fb57829003601f168201915b50505050509050919050565b60008135905061093381610d16565b92915050565b60008135905061094881610d2d565b92915050565b60006020828403121561096057600080fd5b600061096e84828501610924565b91505092915050565b60006020828403121561098957600080fd5b600061099784828501610939565b91505092915050565b60006109ac8383610a80565b905092915050565b6109bd81610c8a565b82525050565b60006109ce82610c29565b6109d88185610c57565b9350836020820285016109ea85610c19565b8060005b85811015610a265784840389528151610a0785826109a0565b9450610a1283610c4a565b925060208a019950506001810190506109ee565b50829750879550505050505092915050565b610a4181610c9c565b82525050565b6000610a5282610c3f565b610a5c8185610c79565b9350610a6c818560208601610cd2565b610a7581610d05565b840191505092915050565b6000610a8b82610c34565b610a958185610c68565b9350610aa5818560208601610cd2565b610aae81610d05565b840191505092915050565b6000610ac482610c34565b610ace8185610c79565b9350610ade818560208601610cd2565b610ae781610d05565b840191505092915050565b610afb81610cc8565b82525050565b6000602082019050610b1660008301846109b4565b92915050565b60006020820190508181036000830152610b3681846109c3565b905092915050565b6000602082019050610b536000830184610a38565b92915050565b60006020820190508181036000830152610b738184610ab9565b905092915050565b60006020820190508181036000830152610b958184610a47565b905092915050565b600060a0820190508181036000830152610bb78188610ab9565b90508181036020830152610bcb8187610ab9565b9050610bda6040830186610af2565b610be76060830185610af2565b610bf46080830184610af2565b9695505050505050565b6000602082019050610c136000830184610af2565b92915050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b6000610c9582610ca8565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b83811015610cf0578082015181840152602081019050610cd5565b83811115610cff576000848401525b50505050565b6000601f19601f8301169050919050565b610d1f81610c8a565b8114610d2a57600080fd5b50565b610d3681610cc8565b8114610d4157600080fd5b5056fea264697066735822122046257a3432feffe77d7d5a008aed17d96d036628f16846a6304044a156f249c564736f6c63430006010033a2646970667358221220d8a6598a558b966713caacd21a3684236afab45fbe3ba6e6a0f6f7c5a8ffc01b64736f6c63430006010033"

     
		let Electioncreationcontract = new web3.eth.Contract(JSON.parse(abi));

        let payload = {
    	data: bytecode
		}	
	let parameter = {
    from: account,
    gas: web3.utils.toHex(5000000),
    gasPrice: web3.utils.toHex(web3.utils.toWei('30', 'gwei'))
	}
	//web3.eth.personal.unlockAccount(account,"123", 15000)
	var contractAddress;

try{
var sampleContract = new web3.eth.Contract(JSON.parse(abi));////															   6000000
sampleContract.options.data = bytecode; //No Need to include '0x' if you have already included it as prefix in the byteCode.// 4000000}
var contractAddress;
sampleContract.deploy(payload).send(parameter).then((receipt) =>{
  if(receipt) {
     contractAddress = receipt.options.address;
     console.log(contractAddress)
     //here receipt is nothing but contractInstanceFromDeployedContract
  }
}).catch(function(error){
   console.log(error);
});}
catch(excep){console.log(excep)}

       function onclickConfirm() {
       	console.log(contractAddress)
    
   // console.log(Electioncreationcontract);
    let requestURL = 'http://134.209.146.188:3000/customers';
	let request = new XMLHttpRequest();
	request.open('GET', requestURL);
	request.responseType = 'json';
	request.send();
	request.onload = function() {
  	const candidates = request.response;
  //console.log(candidates) /// Use this JSON array to load on to the smart contract. 
	var o=-1;
  	for(i =0; i<candidates.length;i++){
  		if((candidateDistrict.indexOf(candidates[i].district) == -1)){
  			candidateDistrict.push(candidates[i].district)
  			o+=1;
  			candidateParty[o]= []
			candidateNames[o] = []
		}
  	

  	candidateNames[o].push(candidates[i].name)
  	
  	candidateParty[o].push(candidates[i].party)

}


console.log(candidateDistrict)
//console.log(candidateParty)

//$("#group_2").click(function() {
var hours= $("#starttim").val();
try{
Electioncreationcontract = new web3.eth.Contract(JSON.parse(abi),contractAddress);



//console.log(a)
const secondFunction = async () => {
var btn = document.getElementById("group_2")
      			btn.style.display = 'none';
  const result = await Electioncreationcontract.methods.startelec(candidateNames,candidateParty,candidateDistrict,hours).send({from : account, gas: 6000000})
 // const a = Electioncreationcontract.methods.getsDeployedBallots();
  //console.log(a.call().value)
  let ballots = await Electioncreationcontract.methods.getsDeployedBallots().call({from : account, gas: 6000000});
	console.log(ballots)
		var jsonToPush=[]
		console.log("Loaded ballots")
		for(i=0;i<ballots.length;i++){
		var jsonObject={}
		jsonObject["district"]=candidateDistrict[i]
		jsonObject["address"]=ballots[i]
		console.log(jsonObject)
		jsonToPush.push(jsonObject)
		}
		console.log(JSON.stringify(jsonToPush))
		let xhr = new XMLHttpRequest(); 
    	let url_post = "http://134.209.146.188:3000/contracts"; 
        
            // open a connection 

    //xhr.setRequestHeader("Origin", 'maximum.blog');
    //for(i=0;i<jsonToPush.length;i++){

    	xhr.open("POST", url_post, true);
    //xhr.setRequestHeader("Origin", 'maximum.blog');
   		 xhr.setRequestHeader("Content-Type", "application/json"); 

  	
  		xhr.send(JSON.stringify(jsonToPush)); 	
  		console.log("Sent address")



console.log(Electioncreationcontract)
  // do something else here after firstFunction completes
}
secondFunction()


}
catch(e){console.log(e)}//.methods.myFunction().call();

   }}
var i;
var candidateNames = []
var candidateParty = new Array();
var candidateDistrict= new Array();


function onBack(){
	window.open("../home/home.html","_self")
}

    </script>
</body> 
</html> 
	
		